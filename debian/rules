#!/usr/bin/make -f
#
# $Id: rules 391 2009-03-07 05:21:19Z aurel32 $
#

# Compiler flags
LDFLAGS = -Wl,--as-needed
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS = -O0
endif

# Support multiple makes at once
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
NJOBS := -j $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
endif

# Architecture/system specific configuration
DEB_HOST_ARCH_OS = $(shell dpkg-architecture -qDEB_HOST_ARCH_OS)
DEB_HOST_ARCH_CPU = $(shell dpkg-architecture -qDEB_HOST_ARCH_CPU)

ifeq ($(DEB_HOST_ARCH_OS),linux)
       conf_arch += --audio-drv-list=alsa,oss,sdl,esd,pa
endif
ifeq ($(DEB_HOST_ARCH_OS),kfreebsd)
       conf_arch += --audio-drv-list=oss,sdl,esd,pa
endif

ifeq ($(DEB_HOST_ARCH_CPU),i386)
       conf_arch += --cpu=i386
endif
ifeq ($(DEB_HOST_ARCH_CPU),sparc)
       conf_arch += --cpu=sparc
endif

include /usr/share/quilt/quilt.make

configure-stamp: configure
	dh_testdir

	# system build
	mkdir -p $(CURDIR)/system-build
	cd $(CURDIR)/system-build && \
		../configure \
			--extra-cflags="$(CFLAGS)" \
			--extra-ldflags="$(LDFLAGS)" \
			--prefix=/usr \
			--disable-blobs \
			--disable-strip \
			--disable-linux-user \
			--disable-bsd-user \
			--disable-darwin-user \
			$(conf_arch)

ifeq ($(DEB_HOST_ARCH_OS),linux)
	# user build
	mkdir -p $(CURDIR)/user-build
	cd $(CURDIR)/user-build && \
		../configure \
			--extra-cflags="$(CFLAGS)" \
			--extra-ldflags="$(LDFLAGS)" \
			--prefix=/usr \
			--disable-blobs \
			--disable-strip \
			--disable-system \
			$(conf_arch)

	# static user build
	mkdir -p $(CURDIR)/user-static-build
	cd $(CURDIR)/user-static-build && \
		../configure \
			--extra-cflags="$(CFLAGS)" \
			--extra-ldflags="$(LDFLAGS)" \
			--prefix=/usr \
			--disable-blobs \
			--disable-strip \
			--disable-system \
			--static \
			$(conf_arch)
endif
	touch $@

build: build-stamp
build-stamp: configure-stamp
	dh_testdir
	
	# system build
	$(MAKE) -C $(CURDIR)/system-build $(NJOBS)

ifeq ($(DEB_HOST_ARCH_OS),linux)
	# user build
	$(MAKE) -C $(CURDIR)/user-build $(NJOBS)

	# static user build
	$(MAKE) -C $(CURDIR)/user-static-build $(NJOBS)
endif
	touch $@

clean: unpatch
	dh_testdir
	dh_testroot
	
	rm -rf $(CURDIR)/*-build
	rm -f $(CURDIR)/*-stamp
	
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs -a
	
	# system build
	$(MAKE) -C $(CURDIR)/system-build DESTDIR=$(CURDIR)/debian/tmp install

	mv $(CURDIR)/debian/tmp/usr/bin/qemu $(CURDIR)/debian/tmp/usr/bin/qemu-system-i386

	zcat /usr/share/etherboot/e1000-82540em.zrom.gz > $(CURDIR)/debian/tmp/usr/share/qemu/pxe-e1000.bin
	zcat /usr/share/etherboot/rtl8029.zrom.gz       > $(CURDIR)/debian/tmp/usr/share/qemu/pxe-ne2k_pci.bin
	zcat /usr/share/etherboot/pcnet32.zrom.gz       > $(CURDIR)/debian/tmp/usr/share/qemu/pxe-pcnet.bin
	zcat /usr/share/etherboot/rtl8139.zrom.gz       > $(CURDIR)/debian/tmp/usr/share/qemu/pxe-rtl8139.bin

	for i in bamboo mpc8544ds ; do \
		dtc -o $(CURDIR)/debian/tmp/usr/share/qemu/$$i.dtb pc-bios/$$i.dts ; \
	done

ifeq ($(DEB_HOST_ARCH_OS),linux)
	# user build
	$(MAKE) -C $(CURDIR)/user-build DESTDIR=$(CURDIR)/debian/tmp install

	# static user build
	for target in $(CURDIR)/user-static-build/*-*-user/qemu-* ; do \
		install -m 755 $$target $(CURDIR)/debian/tmp/usr/bin/$$(basename $$target)-static ; \
	done
endif

	dh_install -s --list-missing

binary-indep:
# Nothing to do.

binary-arch: build install
	dh_testdir
	dh_testroot
	dh_install -a
	dh_installdocs -a
	dh_installman -a
	dh_installchangelogs -a Changelog
	dh_link -a
	dh_strip -a
	dh_compress -a
	dh_fixperms -a
	chmod a+x $(CURDIR)/debian/qemu-system/etc/qemu-ifup
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch

.PHONY: build clean binary-indep binary-arch binary install

